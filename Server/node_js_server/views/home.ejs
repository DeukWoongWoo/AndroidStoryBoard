<!DOCTYPE html>
<html>
<head>
    <title>Android Storyboard</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Sigmar+One' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Candal' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="stylesheets/mystyle.css">


    <script type="text/javascript" src="javascripts/d3/d3.js"></script>
    <script src="javascripts/graph/Graph.js"></script>
    <script src="javascripts/graph/Bar.js"></script>
    <script src="javascripts/graph/Line.js"></script>
    <script src="javascripts/graph/Circle.js"></script>
    <script src="javascripts/drag.js"></script>

    <script>
        var sideMenu = function () {
            $('.fa').mouseover(function () {
                $(this).css("color", "gray");
            }).mouseout(function () {
                $(this).css("color", "");
            });

            $('.fa-bars').click(function () {
                $('.sidebar').animate({
                    left: "0px"
                }, 200);

                $('.content-body').animate({
                    left: "300px"
                }, 200);

                $('.fa-bars').css(
                        "visibility", "hidden"
                );
            });

            $('.fa-times').click(function () {
                $('.sidebar').animate({
                    left: "-300px"
                }, 200);

                $('.content-body').animate({
                    left: "0px"
                }, 200);

                $('.fa-bars').css(
                        "visibility", ""
                );
            });

            $('.main-body').click(function () {
                $('.sidebar').animate({
                    left: "-300px"
                }, 200);

                $('.content-body').animate({
                    left: "0px"
                }, 200);

                $('.fa-bars').css(
                        "visibility", ""
                );
            });
        }
        var registerApp = function () {
            $('#register-app').click(function () {
                $('.register-app-form').css("display", "");
                $('#register-app').css("display", "none");
            });

            $('#register-app-close').click(function () {
                $('.register-app-form').css("display", "none");
                $('#register-app').css("display", "");
            });
        }

        var main = function () {
            sideMenu();
            registerApp();

            $('#rect-info-close').click(function () {
                $(this).parent().parent().css("visibility", "hidden");
            });

            $('.rect-info').css("left", screen.width * 0.3 + "px").css("top", screen.height * 0.3 + "px");
        };

        $(document).ready(main);
    </script>

</head>
<body>
<div class="sidebar">
    <div class="container-fluid" id="menu-close"><i class="fa fa-times"></i></div>
    <div class="container-center">
        <button class="btn btn-danger" id="register-app">Register App</button>
    </div>

    <div class="register-app-form" style="display: none;">
        <form method="post" action="/registerapp" enctype="multipart/form-data">
            <input type="text" class="form-control" name="app_name" placeholder="App Name"/>
            <label for="exampleInputFile">File Upload</label>
            <input type="file" name="storyboard">
            <p class="help-block">Upload StoryBoard File</p>
            <div class="container-center">
                <button type="submit" class="btn btn-primary" id="register-app-confirm">Confirm</button>
                <button type="button" class="btn btn-warning" id="register-app-close">Close</button>
            </div>

        </form>
    </div>

    <div class="menu">
        <b style="font-size:30px;">App List</b>
        <ul>
            <% app.forEach(function (app) { %>
            <li><a class="btn btn-inverse app_name" href="#"><%= app.app_name %></a></li>
            <% }) %>
        </ul>
    </div>
</div>
<div class="navigation">
    <div class="container-fluid">
        <div class="left" id="menu-button" style="display: inline-block; width:20%;"><i class="fa fa-bars"></i></div>
        <div style="display: inline-block;">
            <a href="/" class="main-logo">AndroidStoryBoard</a>
        </div>
        <div class="right" style="display: inline-block;">
            <b id="user_id"><%= user_id %></b>
            <a class="btn btn-info" href="/profile">Profile</a>
            <a class="btn btn-info" href="/logout">Logout</a>
        </div>
    </div>
</div>

<div class="content">
    <div class="content-body">
        <div class="container-center">
            <h3 id="current_app_name">&nbsp</h3>
            <form method="post" action="/date-search" class="form-inline">
                <input type="date" class="form-control" name="start_date"/>
                ~
                <input type="date" class="form-control" name="end_date"/>
                <button type="submit">search</button>
            </form>
        </div>

        <div class="main-body container-center" id="graphs">
            <div class="graph" id="use-graph" style="display: inline-block"></div>
            <div class="graph" id="use-line-graph" style="display: inline-block"></div>
            <div class="graph" id="err-graph" style="display: inline-block"></div>
            <div class="graph" id="err-line-graph" style="display: inline-block"></div>
        </div>
    </div>
</div>
<!--<div style="height : 100px"></div>-->
<div class="rect-info"
     style="position: absolute; visibility: hidden; left:20px; top:20px; background-color: #68606A; height: auto; position: fixed;  width: 200px;"
     onmousedown="startDrag(event, this)">
    <div class="rect-info-bar" style="background: #A3A7B7; height:15px; width: auto;">
        <div id="rect-info-close"><i class="fa fa-times right" style="font-size: 15px;"></i></div>
    </div>
    <div style=" color:white">
        <b>object name : </b><b class="rect-value" id="rect-object-name"></b>
        <hr class="magin0">
        <b>object use frequency : </b><b class="rect-value" id="rect-use-frequency"></b>
        <hr class="magin0">
        <b>object err frequency : </b><b class="rect-value" id="rect-err-frequency"></b>
        <hr class="magin0">
        <b>activity name : </b><b class="rect-value" id="rect-activity-name"></b>
        <hr class="magin0">
        <b>activity using time : </b><b class="rect-value" id="rect-activity-time"></b>
        <hr class="magin0">
    </div>
</div>
<script>
    var useGraph = new Graph();
    var errGraph = new Graph();
    var useLineGraph = new Graph();
    var useCircleGraph = new Graph();
    var errLineGraph = new Graph();

    var useBar = new Bar('use');
    var errBar = new Bar('err');
    var useLine = new Line();
    var errLine = new Line();
    var circle = new Circle();

    var useFrequency = null;
    var errFrequency = null;
    var objectName = null;
    var objectNum = null;
    var occur_time = null;

    var useTime = null;
    var errTime = null;

    var app_name;
    var user_id;
    var intervalID;

    useGraph.setDataColor('#457D97');
    errGraph.setDataColor('#EA3556');
    useLineGraph.setDataColor('#02779E');
    errLineGraph.setDataColor('#EA3556');
//    useCircleGraph.setDataColor('#02779E');

    $('.app_name').click(function () {
        app_name = $(this).text();
        user_id = $('#user_id').text();
        $.post("/get/object_info", {app_name: app_name, user_id: user_id}
                , function (data) {
                    initDataToArray();
                    for (var i = 0; i < data.length; i++) {
                        setObjectData(i, data);
                    }
                    createGraphs();
                    clearInterval(intervalID);
                    intervalID = setInterval(update, 2000);

                    rectMouseOver();
                });
    });

    function initDataToArray() {
        useFrequency = new Array();
        errFrequency = new Array();
        objectName = new Array();
        objectNum = new Array();
        useTime = new Array(12);
        errTime = new Array(12);
    }

    function setObjectData(i, data) {
        useFrequency[i] = data[i].object_frequency;
        errFrequency[i] = data[i].error_frequency;
        objectName[i] = data[i].object_name;
        objectNum[i] = data[i].object_num;
    }

    function createGraphs() {
        useGraph.location('#use-graph')
                .graphData(useFrequency)
                .graphDataName(objectName)
                .graphDataNnum(objectNum)
                .createGraph()
                .setGraphType(useBar).create();

        errGraph.location('#err-graph')
                .graphData(errFrequency)
                .graphDataName(objectName)
                .graphDataNnum(objectNum)
                .createGraph()
                .setGraphType(errBar).create();

        useLineGraph.location('#use-line-graph')
                .graphData(useTime)
                .createGraph()
                .setGraphType(useLine).create();

        errLineGraph.location('#err-line-graph')
                .graphData(errTime)
                .createGraph()
                .setGraphType(errLine).create();
    }

    function update() {
        $.post("/get/object_info", {app_name: app_name, user_id: user_id}
                , function (data) {
                    for (var i = 0; i < data.length; i++) {
                        useFrequency[i] = data[i].object_frequency;
                        errFrequency[i] = data[i].error_frequency;
                    }

                    useGraph.graphData(useFrequency).update();
                    errGraph.graphData(errFrequency).update();

//                    useLineGraph.setGraphType(circle).graphData(useFrequency).update();
//                    useLineGraph.setGraphType(line).graphData(useFrequency).update();
                });
    }

    function rectMouseOver() {
        $('.graph').children('svg').children('rect').mouseover(function () {
            var className = '.' + $(this).attr("class");
            var objectNum = $(this).attr("object-num");

            highlightByClassName(className);
            popObjectInfoByClassName.call(this, className);

            getObjectInfo(objectNum);
            getErrorInfo(objectNum);
        }).mouseout(function () {

        });
    }

    var rDate =  new Date('2016/01/01');
    var tDate =  new Date('2017/02/01');
    var testT;

    console.log("- test : " + tDate.getTime());
    testT = tDate.getTime() - 100000000000;
    console.log("testT : " + testT);
    console.log("testT2 : " + (new Date(testT)));

    function getObjectInfo(objectNum) {
        $.post("/get/object_use_info", {object_num: objectNum}
                , function (data) {
                    occur_time = new Array();
                    useTime = new Array(12);
                    for (var i = 0; i < data.length; i++)
                        occur_time[i] = new Date(data[i].occur_time).getMonth();
                    for (var i = 0; i < 12; i++)
                        useTime[i] = 0;
                    for (var i = 0; i < occur_time.length; i++)
                        useTime[occur_time[i]]++;

                    useLineGraph.graphData(useTime).setEase("circle-out").update();
                });
    }

    function getErrorInfo(objectNum) {
        $.post("/get/error_use_info", {object_num: objectNum}
                , function (data) {
                    occur_time = new Array();
                    errTime = new Array(12);
                    for (var i = 0; i < data.length; i++)
                        occur_time[i] = new Date(data[i].occur_time).getMonth();
                    for (var i = 0; i < 12; i++)
                        errTime[i] = 0;
                    for (var i = 0; i < occur_time.length; i++)
                        errTime[occur_time[i]]++;

                    errLineGraph.graphData(errTime).setEase("circle-out").update();
                });
    }
    function NumOfDate(date) {
        /**
         *  날짜, 시간에 문자열을 숫자로 표현된 값으로 반환
         */
        var piece = date.split(" ");
        var standardYears = 1990 * 60 * 60 * 30 * 12;
        var years = piece[0].split("-")[0] * 60 * 60 * 30 * 12 - standardYears;
        var month = piece[0].split("-")[1] * 60 * 60 * 30;
        var days = piece[0].split("-")[2] * 60 * 60 * 24;
        var hours = piece[1].split(":")[0] * 60 * 60;
        var minutes = piece[1].split(":")[1] * 60;
        var seconds = piece[1].split(":")[2] * 1;

        return years + month + days + hours + minutes + seconds;
    }

    function highlightByClassName(className) {
        $('rect').css("fill", "");
        $('circle').css("fill", "");
        $('rect' + className).css("fill", "gold");
        $('circle' + className).css("fill", "red");
    }

    function popObjectInfoByClassName(className) {
        var useFrequency = $('#use-graph ' + className).attr("use-data");
        var errFrequency = $('#err-graph ' + className).attr("err-data")

        var rectInfo = $('.rect-info').children('div');
        var objectName = $(this).attr("object-name");

        $('.rect-info').css("visibility", "visible");
        rectInfo.children('#rect-object-name').text(objectName);
        rectInfo.children('#rect-use-frequency').text(useFrequency);
        rectInfo.children('#rect-err-frequency').text(errFrequency);
    }

</script>
</body>
</html>